<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>criticalheap - frozenkp's Blog</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "criticalheap", url: "#_top", children: [
              {title: "Observation", url: "#observation" },
              {title: "Solution", url: "#solution" },
              {title: "Note", url: "#note" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../../pwn/stack_migration/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../../pwn/stack_migration/" class="btn btn-xs btn-link">
        Stack Migration
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../dubblesort/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../dubblesort/" class="btn btn-xs btn-link">
        dubblesort
      </a>
    </div>
    
  </div>

    

    <h1 id="criticalheap">criticalheap</h1>
<blockquote>
<p>Challenge link: <a href="https://pwnable.tw/challenge/#8">criticalheap</a></p>
<p>Category: pwn</p>
<p>Writeup: <a href="https://github.com/frozenkp/CTF/tree/master/others/pwnable.tw/criticalheap">criticalheap</a></p>
</blockquote>
<p>There are some secrets . Try to capture <code>/home/critical_heap++/flag</code>.</p>
<p>We recommend you to use the provided docker environment to develop your exploit:</p>
<p><code>nc chall.pwnable.tw 10500</code></p>
<p><a href="https://pwnable.tw/static/chall/critical_heap.tar.gz">critical_heap.tar.gz</a></p>
<h2 id="observation">Observation</h2>
<p>這題有很多個選項可以使用，以下講可能會用到的部分</p>
<h3 id="struct">struct</h3>
<p>這題有三個 struct (normal, time, system) 在一個 union，一開始就先在 .bss 段宣告長度 10 的 struct 陣列，其中某些變數 (name, value...) 是存字串的指標</p>
<h4 id="normal">normal</h4>
<div class="highlight"><pre><span></span><code>00000000 name
...
00000018 content
...
</code></pre></div>
<h4 id="system">system</h4>
<div class="highlight"><pre><span></span><code>00000000 name
...
00000020 value
...
</code></pre></div>
<h3 id="create">create</h3>
<h4 id="name">name</h4>
<p>name 的部分是先 read 進來以後，用 strdup 放到 struct 上的，所以也是存在 heap 上</p>
<p><img alt="" src="https://i.imgur.com/fbl69dp.png" /></p>
<h4 id="normal_1">normal</h4>
<p>normal 的部分需要輸入 content，它是直接 read 到 rax + 0x18 (struct 上的 0x18) 的位置，沒有在後面補上 <code>0x00</code></p>
<p><img alt="" src="https://i.imgur.com/7ZPpc3s.png" /></p>
<h4 id="time">time</h4>
<p>time 會用 localtime 拿取現在的時間以後，處理完存進 struct</p>
<p><img alt="" src="https://i.imgur.com/Th8VE6i.png" /></p>
<p>localtime 先使用 getenv 抓取環境變數 TZ 的值，接著讀出 TZ 所指的檔案，並將內容存在 heap 上</p>
<p><img alt="" src="https://i.imgur.com/kzabx9I.png" /></p>
<p><img alt="" src="https://i.imgur.com/XUBYeD0.png" /></p>
<h3 id="play_system">play_system</h3>
<h4 id="set-the-name-for-the-heap">Set the name for the heap</h4>
<p>這個功能其實就是 setenv</p>
<p><img alt="" src="https://i.imgur.com/JeUENVX.png" /></p>
<h4 id="unset-the-name-in-the-heap">Unset the name in the heap</h4>
<p>這個功能是 unsetenv</p>
<p><img alt="" src="https://i.imgur.com/GtViGDw.png" /></p>
<h4 id="get-the-value-of-name">Get the value of name</h4>
<p>這個功能比較特別，會先用 getenv 抓輸入的 name，接著將抓到的指標 (指向 heap 上存 value 處) 存在 rax + 0x20 (struct 上 0x20 的位置)</p>
<p><img alt="" src="https://i.imgur.com/R67Ah33.png" /></p>
<h3 id="play_normal">play_normal</h3>
<h4 id="show-the-content-of-heap">Show the content of heap</h4>
<p>這個功能有 format string 的漏洞，而且是使用 printf_chk</p>
<p><img alt="" src="https://i.imgur.com/ssfVY7r.png" /></p>
<h3 id="delete">delete</h3>
<p>delete 實際上只有把指定的 struct 標成 0 而已，上面的資訊並沒有清空</p>
<p><img alt="" src="https://i.imgur.com/WLIYn6j.png" /></p>
<h3 id="conclusion">Conclusion</h3>
<ul>
<li>create_normal 讀取 content 時沒有結尾</li>
<li>play_normal 有 format string 的漏洞</li>
<li>setenv 可以改動 TZ 的值</li>
<li>delete 沒有清空</li>
</ul>
<h2 id="solution">Solution</h2>
<p>解法步驟如下：</p>
<ol>
<li>leak heap base 位置</li>
<li>利用 setenv 改動 TZ 以後，用 localtime 將 flag 讀到 heap 上</li>
<li>利用 format string 印出 flag</li>
</ol>
<h3 id="leak-heap-base">leak heap base</h3>
<p>這個部分要利用 "delete 沒有清空" 的漏洞</p>
<p>先創 system，接著到 play 隨便創一個環境變數，再使用 play_system_get_value 來將環境變數的位址放到 struct 上，這是為了取得一段 heap address</p>
<div class="highlight"><pre><span></span><code>0x000 name
0x020 value  (heap address)
</code></pre></div>
<p>接著 delete 掉，然後創一個 normal 的 struct，此時 normal struct 會蓋在 system struct 原本的位置上</p>
<p>因為 content 存在 0x18，與原本的 value 差 0x8，要輸入 8 個字元才能碰到 value 的位置</p>
<blockquote>
<p>不要輸入 \n 不然輸出會被截斷</p>
</blockquote>
<div class="highlight"><pre><span></span><code>0x000 name
0x018 content (&#39;AAAAAAAA&#39;)
0x020 value  (heap address)
</code></pre></div>
<p>最後就使用 show 把 struct 印出來就可以得到 heap address 了</p>
<p>因為在 heap 上相對位置不變，用 gdb 看一下跟 base 差多遠，leak 出來後減掉就是 heap base 了</p>
<h3 id="tz">TZ</h3>
<p>這個部分就創一個 system 然後用 setenv 把 TZ 設成 <code>/home/critical_heap++/flag</code></p>
<p>接著創一個 time struct，就會在 localtime 將 flag 讀取到 heap 上了，然後用 gdb 看一下 offset 搭配 heap base 就可以知道 flag address 了</p>
<p><img alt="" src="https://i.imgur.com/o5RZhBc.png" /></p>
<h3 id="format-string">format string</h3>
<p>利用 format string 搭配 %s 可以 leak 任意位址的特性來 leak flag address</p>
<p>另外，因為是使用 printf_chk 的關係，不能使用 <code>$</code> 要自己用 %c 來跳到指定區域</p>
<p><img alt="" src="https://i.imgur.com/wniwxLP.png" /></p>
<h2 id="note">Note</h2>
<h3 id="peda-in-docker">peda in docker</h3>
<p>這次有給一個 docker 的環境，要在裡面使用 gdb-peda 的話，要改動以下設定</p>
<h4 id="dockerfile">Dockerfile</h4>
<div class="highlight"><pre><span></span><code><span class="k">RUN</span> apt-get install gdb git -y
<span class="k">WORKDIR</span><span class="s"> /root</span>
<span class="k">RUN</span> git clone https://github.com/scwuaptx/Pwngdb.git <span class="p">;</span> cp ~/Pwngdb/.gdbinit ~/
<span class="k">RUN</span> git clone https://github.com/scwuaptx/peda.git ~/peda <span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;source ~/peda/peda.py&quot;</span> &gt;&gt; ~/.gdbinit <span class="p">;</span> cp ~/peda/.inputrc ~/
</code></pre></div>
<h4 id="docker-composeyml">docker-compose.yml</h4>
<div class="highlight"><pre><span></span><code><span class="nt">critical_heap</span><span class="p">:</span>
    <span class="nt">cap_add</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SYS_PTRACE</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../../pwn/stack_migration/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../../pwn/stack_migration/" class="btn btn-xs btn-link">
        Stack Migration
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../dubblesort/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../dubblesort/" class="btn btn-xs btn-link">
        dubblesort
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/frozenkp/frozenkp.github.io/edit/master/docs/Writeups/Others/pwnable.tw/criticalheap.md">Edit on frozenkp/frozenkp</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>