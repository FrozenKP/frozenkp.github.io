<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>water-impossible - frozenkp's Blog</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "water-impossible", url: "#_top", children: [
              {title: "\u9808\u5177\u5099\u7684\u77e5\u8b58", url: "#_1" },
              {title: "\u89c0\u5bdf", url: "#_3" },
              {title: "\u89e3\u6cd5", url: "#_4" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../infant-gotoheaven/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../infant-gotoheaven/" class="btn btn-xs btn-link">
        infant-gotoheaven
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../../2017/seccon_CTF/putchar_music/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../../2017/seccon_CTF/putchar_music/" class="btn btn-xs btn-link">
        putchar music
      </a>
    </div>
    
  </div>

    

    <h1 id="water-impossible">water-impossible</h1>
<blockquote>
<p>Challenge Link: <a href="http://ctf.bamboofox.cs.nctu.edu.tw/challenges#water-impossible">water-impossible</a></p>
<p>Category: pwn</p>
<p>Writeup: <a href="https://github.com/frozenkp/CTF/tree/master/2018/BambooFox_CTF_2018/water-impossible">water-impossible</a></p>
</blockquote>
<p>Welcome !! Challenger ~</p>
<p>Here is a simple challenge for you.</p>
<p>Try to find the key to pass.</p>
<p><code>nc bamboofox.cs.nctu.edu.tw 58799</code></p>
<p><a href="http://ctf.bamboofox.cs.nctu.edu.tw/files/bb63dedd19b55a8fab5a08f28dea6269/water-impossible.zip">water-impossible.zip</a></p>
<h2 id="_1">須具備的知識</h2>
<h3 id="stack">Stack</h3>
<p>stack 是程式在執行中用來儲存資料的結構，儲存的資料如</p>
<ul>
<li>暫時的值</li>
<li>return address</li>
<li>區域變數</li>
<li>...</li>
</ul>
<h3 id="rsp">rsp</h3>
<p><code>rsp</code> 是用來儲存 stack 所在位置的暫存器</p>
<h3 id="_2">區域變數</h3>
<p>宣告區域變數時，會將值存在 stack 上</p>
<p>假設宣告兩個變數 a, b</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div>
<p>宣告 a 時，stack 狀態如下</p>
<div class="highlight"><pre><span></span><code>+----------+    0x7fffffffe728  low
|  a = 1   |
+----------+    0x7fffffffe730
|   ...    |
+----------+    0x7fffffffe738  high
</code></pre></div>
<p>宣告 b 時，stack 狀態如下</p>
<div class="highlight"><pre><span></span><code>+----------+    0x7fffffffe720  low
|  b = 2   |
+----------+    0x7fffffffe728
|  a = 1   |
+----------+    0x7fffffffe730
|   ...    |
+----------+    0x7fffffffe738  high
</code></pre></div>
<p>當 push 值進 stack 時，<code>rsp</code> 的位置會減足夠的大小，讓新的值可以填進來，所以後進來的 b 反而會存在較低位的地方</p>
<h3 id="buffer-overflow">Buffer overflow</h3>
<p>在讀取輸入的時候，輸入的大小超過變數的大小，此時多的部份會超越區域變數的位址，進而蓋到 stack 上的其他位置</p>
<p>假設有一程式如下</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="n">key</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="n">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div>
<p>宣告後 stack 狀態如下</p>
<div class="highlight"><pre><span></span><code>+----------------+  0x7fffffffe720    low  &lt;-----+
|     0x0    |               |
+----------------+  0x7fffffffe728       |  buf[16]
|     0x0    |               |
+----------------+  0x7fffffffe730         &lt;-----+-----+
|   0xdeadbeef   |                                     | key
+----------------+  0x7fffffffe738    high &lt;-----------+
</code></pre></div>
<p>因為 gets 沒有限制輸入的長度，因此可以輸入超過 buf 長度，此時多的部份就會蓋到 stack 其他部份</p>
<p>例如輸入 <code>aaaaaaaabbbbbbbbcccccccc</code></p>
<div class="highlight"><pre><span></span><code>+----------------+  0x7fffffffe720    low  &lt;-----+
|   aaaaaaaa     |               |
+----------------+  0x7fffffffe728               |  buf[16]
|   bbbbbbbb     |                               |
+----------------+  0x7fffffffe730         &lt;-----+-----+
|   cccccccc     |                     | key
+----------------+  0x7fffffffe738    high &lt;-----------+
</code></pre></div>
<p>原本 <code>key</code> 存的位置就被 buf 的輸入蓋掉了</p>
<h2 id="_3">觀察</h2>
<p>觀察一下code後可以發現觸發<code>system("/bin/sh")</code>的條件為<code>(int)token == 6666</code></p>
<p>而token是一個宣告在<code>main</code>但從未被使用到的變數</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">token</span> <span class="o">==</span> <span class="mi">6666</span><span class="p">){</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;wow, That&#39;s impossible to touch this token ?!&quot;</span><span class="p">);</span>
  <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>另外可以被exploit的部份為<code>read()</code>的 buffer overflow</p>
<div class="highlight"><pre><span></span><code><span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
</code></pre></div>
<p>通常這類題目可能的作法有以下兩種</p>
<h3 id="return">蓋 return</h3>
<p>如果stack一直往下蓋的話可以碰到<code>return</code>，那就直接跳到<code>system("/bin/sh")</code>就好了</p>
<p>不過這題有限制長度40，所以沒辦法蓋到return</p>
<h3 id="token">蓋 token</h3>
<p>因為<code>token</code>也是宣告在stack上，應該可以找到<code>token</code>的位置後直接蓋成想要的值</p>
<h2 id="_4">解法</h2>
<p>以下解法是用蓋token的方法</p>
<h3 id="paylod">找 paylod 長度</h3>
<p>先輸入以下字串來定位</p>
<div class="highlight"><pre><span></span><code>AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFF
</code></pre></div>
<p>到<code>if((int)token == 6666)</code>時 stack 狀態如下</p>
<p><img alt="" src="https://i.imgur.com/0wDePvP.png" /></p>
<p>上圖可以看到<code>token</code>的位置以及內容是<code>[rbp-0x4] : 0x7fffffffdf1c ("DDDDEEEEEEEE0آ\367\377\177")</code></p>
<p>由此可知到<code>token</code>之前，所需要的 payload 長度是 <strong>28</strong> ，也就是</p>
<div class="highlight"><pre><span></span><code>AAAAAAAABBBBBBBBCCCCCCCCDDDD
</code></pre></div>
<h3 id="token_1">蓋token的值</h3>
<p>因為這支程式是在 <strong>64位元</strong> 的環境編譯的，所以送的時候要給64位元的位址，使用 pwntool 的話只要用<code>p64()</code>就可以囉</p>
<div class="highlight"><pre><span></span><code><span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x1a0a</span><span class="p">))</span>
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../infant-gotoheaven/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../infant-gotoheaven/" class="btn btn-xs btn-link">
        infant-gotoheaven
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../../2017/seccon_CTF/putchar_music/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../../2017/seccon_CTF/putchar_music/" class="btn btn-xs btn-link">
        putchar music
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/frozenkp/frozenkp.github.io/edit/master/docs/Writeups/2018/BambooFox_CTF/water-impossible.md">Edit on frozenkp/frozenkp</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>